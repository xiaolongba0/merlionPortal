<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
    </h:head>
    <h:body>
        <ui:composition>
            <script type="text/javascript">
                function openEditor() {
                    $("#editorDialog").modal('show');
                }
                function closeEditor() {
                    $("#editorDialog").modal('hide');
                }

                function verifyEmail(result) {
                    if (result > -1) {
                        $("#receipentid").val(result);
                        $("#sendemailBtn").removeAttr("disabled");
                        $.notify("User found.", "success");
                    } else {
                        $("#sendemailBtn").attr("disabled", "disabled");
                        $.notify("User do not exist in system.", "error");
                        $("#emailAddress").val("");
                    }
                }

                function sendEmail() {
                    document.getElementById('messagingForm:sendEmail').click();
                    return false;
                }

                function broadCastMail() {
                    document.getElementById('messagingForm:broadCastMail').click();
                    return false;
                }

                function postReadMail(title, content, senderEmail) {
                    var mailReader = $("#messageReader");
                    $("#readMsgTitle").html(title);
                    $("#readMsgContent").html(content);
                    $("readMsgSender").html("From " + senderEmail);
                    $("#replyBtn").unbind("click");
                    $("#replyBtn").click({
                        "senderEmail": senderEmail,
                        "title": title
                    }, function(e) {
                        reply(e.data.senderEmail, e.data.title);
                    });

                    $("#deleteBtn").unbind("click");
                    $("#deleteBtn").click(function(e) {
                        deleteMail();
                    });

                    mailReader.removeClass("hide");
                }

                function deleteMail() {
                    document.getElementById('messagingForm:deleteEmail').click();
                    return false;
                }

                function postDeleteMail() {
                    var msgid = $("#selectmsgid").val();
                    $("#msg_" + msgid).remove();
                    $("#selectmsgid").val("-1");
                    var mailReader = $("#messageReader");
                    $("#inboxMessages").find("li").removeClass("active");
                    $("#readMsgTitle").html("");
                    $("#readMsgContent").html("");
                    $("readMsgSender").html("");
                    mailReader.addClass("hide");
                    $.notify("Mail Deleted", "success");
                }

                function readMail(menuitem, id) {
                    $("#inboxMessages").find("li").removeClass("active");
                    $(menuitem).addClass("active");
                    $("#selectmsgid").val(id);
                    document.getElementById('messagingForm:readEmail').click();
                    return false;
                }

                function reply(email, title) {
                    openEditor();
                    $("#emailAddress").val(email);
                    $("#subject").val("RE: " + title);
                    document.getElementById('messagingForm:verifyEmail').click();
                    return false;
                }

                function postEmail(res) {
                    if (res > -1) {
                        $.notify("Message sent.", "success");
                        closeEditor();
                    } else {
                        $.notify("Message not sent.", "error");
                    }
                }

                $(document).ready(function() {
                    $("#editorDialog").on('hide.bs.modal', function(e) {
                        $("#emailAddress").val("");
                        $("#subject").val("");
                        $("#content").val("");
                        $("#sendemailBtn").attr("disabled", "disabled");
                    });
                    $("#emailAddress").keypress(function(e) {
                        if (e.keyCode === 13) {
                            document.getElementById('messagingForm:verifyEmail').click();
                            return false;
                        }
                    });
                    $("#emailAddress").on("focusout", function(e) {
                        document.getElementById('messagingForm:verifyEmail').click();
                        return false;
                    });
                });</script>
            <div class="container">
                <div class="row">
                    <div class="col-md-2">
                        <h2>
                            Inbox 
                            <i class="glyphicon glyphicon-briefcase"></i>
                        </h2>
                    </div>
                    <div class="col-md-2">
                        <h2>Outbox
                            <button class="btn btn-primary" onclick="openEditor();">Write Message <i class="glyphicon glyphicon-pencil"></i></button>
                        </h2>
                    </div>
                    <div class="col-md-8">
                        <div id="messageReader" class="hide">
                            <h2 id="readMsgTitle"></h2>
                            <div id="readMsgSender"></div>
                            <div id="readMsgContent"></div>
                            <button id="replyBtn" class="btn btn-primary">Reply</button>
                            <button id="deleteBtn" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <c:choose> 
                        <c:when test="${empty messagerBean.inbox}">
                            <div class="col-md-6">
                                No inbox message found. Start sending a <span class="message-link text-primary" onclick="openEditor();">message</span> today!
                            </div>
                        </c:when>
                        <c:otherwise>
                            <div class="col-md-2">
                                <h4>Messages</h4>
                                <ul id="inboxMessages" class="list-group">
                                    <c:forEach items="#{messagerBean.inbox}" var="message">
                                        <c:choose>
                                            <c:when test="#{message.status == 9990}">
                                                <li id="msg_#{message.messageId}" class="list-group-item list-group-item-info pointer" onclick="readMail(this,#{message.messageId});">#{message.messageTitle}</li>
                                            </c:when>
                                            <c:when test="#{message.status == 9991}">
                                                <li id="msg_#{message.messageId}" class="list-group-item pointer" onclick="readMail(this,#{message.messageId});">#{message.messageTitle}</li>
                                            </c:when>
                                        </c:choose>
                                    </c:forEach>
                                </ul>
                            </div>
                        </c:otherwise>
                    </c:choose>
                    <c:choose> 
                        <c:when test="${empty messagerBean.outbox}">
                            <div class="col-md-6">
                                No outbox found. Start sending a <span class="message-link text-primary" onclick="openEditor();">message</span> today!
                            </div>
                        </c:when>
                        <c:otherwise>
                            <div class="col-md-2">
                                <h4>Messages</h4>
                                <ul id="inboxMessages" class="list-group">
                                    <c:forEach items="#{messagerBean.outbox}" var="message">
                                        <c:choose>
                                            <c:when test="#{message.status == 9990}">
                                                <li id="msg_#{message.messageId}" class="list-group-item list-group-item-info pointer" onclick="readMail(this,#{message.messageId});">#{message.messageTitle}</li>
                                            </c:when>
                                            <c:when test="#{message.status == 9991}">
                                                <li id="msg_#{message.messageId}" class="list-group-item pointer" onclick="readMail(this,#{message.messageId});">#{message.messageTitle}</li>
                                            </c:when>
                                        </c:choose>
                                    </c:forEach>
                                </ul>
                            </div>
                        </c:otherwise>
                    </c:choose>
                </div>
            </div>
            <div id="editorDialog" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content wide-modal">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                            <h3 class="modal-title">Compose Message</h3>
                        </div>
                        <div class="modal-body">
                            <h:form id="messagingForm">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="input-group">
                                            <div class="input-group-addon">
                                                From
                                            </div>
                                            <input value="#{dashboardBean.loginedUser.emailAddress}" type="text" class="form-control" disabled="disabled" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row morespacing">
                                    <div class="col-md-12">
                                        <div class="input-group">
                                            <div class="input-group-addon">
                                                To
                                            </div>
                                            <input class="form-control" type="text" id="emailAddress" name="emailAddress" />
                                        </div>
                                        <div id="receipenterrbox" class="text-danger hide"></div>
                                    </div>
                                </div>
                                <div class="row morespacing">
                                    <div class="col-md-12">
                                        <div class="input-group">
                                            <div class="input-group-addon">
                                                Subject
                                            </div>
                                            <input class="form-control" type="text" id="subject" name="subject" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row morespacing">
                                    <div class="col-md-12">
                                        <textarea class="form-control message-content-area" type="text" id="content" name="content"></textarea>
                                    </div>
                                </div>
                                <input type="hidden" id="receipentid" name="receipentid" value="" />
                                <p:commandLink id="readEmail" style="display:none;" actionListener="#{messagerBean.readMail}" ajax="true" />
                                <p:commandLink id="verifyEmail" style="display:none;" actionListener="#{messagerBean.verifyEmail}" ajax="true" />
                                <p:commandLink id="sendEmail" style="display:none;" actionListener="#{messagerBean.sendEmail}" ajax="true" />
                                <p:commandLink id="deleteEmail" style="display:none;" actionListener="#{messagerBean.deleteEmail}" ajax="true" />
                                <p:commandLink id="broadCastMail" style="display:none;" actionListener="#{messagerBean.broadcastMail}" ajax="true" />
                                <!-- Hidden Fields -->
                                <input type="hidden" id="selectmsgid" name="selectmsgid" value="-1" />
                            </h:form>
                        </div>
                        <div class="modal-footer">
                            <button id="sendemailBtn" type="button" class="btn btn-primary" onclick="sendEmail();" disabled="disabled">Send Email</button>
                            <button id="broadcastmailBtn" type="button" class="btn btn-warning" onclick="broadCastMail();">Broadcast Email</button>
                            <button id="closeEditorBtn" type="button" class="btn btn-danger" onclick="closeEditor();">Close</button>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->

        </ui:composition>
    </h:body>
</html>